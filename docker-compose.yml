

services:
  api-gateway:
    build: ./api-gateway
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      API_GATEWAY_PORT: 3000
      JWT_SECRET: votre_super_secret_jwt_2024
      LOCATION_SERVICE_URL: http://location-service:5002
      USER_SERVICE_URL: http://user-service:5000
      AQI_SERVICE_URL: http://aqi-service:5003
      NOTIFICATION_SERVICE_URL: http://notification-service:5004
      AI_SERVICE_URL: http://ai-service:5005
    depends_on:
      - location-service
      - user-service
      - ai-service
      - aqi-service
      - notification-service
    networks:
      - app-network

  user-service:
    build: ./user-service
    ports:
      - "5000:5000"
    environment:
      NODE_ENV: development
      JWT_SECRET: votre_super_secret_jwt_2024
      USER_SERVICE_PORT: 5000
    volumes:
      - user-data:/data
    networks:
      - app-network

  aqi-service:
    build: ./aqi-service
    ports:
      - "5003:5003"
    environment:
      NODE_ENV: development
      JWT_SECRET: votre_super_secret_jwt_2024
      AQI_SERVICE_PORT: 5003
      KAFKA_BROKER: kafka:9092
      AI_SERVICE_URL: http://model-serving:8000
      AQICN_API_KEY: ${AQICN_API_KEY}
    volumes:
      - aqi-data:/data
    depends_on:
      - kafka
      - ai-service
    networks:
      - app-network

  location-service:
    build: ./location-service
    ports:
      - "5002:5002"
    environment:
      NODE_ENV: development
      JWT_SECRET: votre_super_secret_jwt_2024
      LOCATION_SERVICE_PORT: 5002
    volumes:
      - ./location-service/data:/app/data
    networks:
      - app-network

  notification-service:
    build: ./notification-service
    ports:
      - "5004:5004"
    environment:
      NODE_ENV: development
      JWT_SECRET: votre_super_secret_jwt_2024
      NOTIFICATION_SERVICE_PORT: 5004
      KAFKA_BROKER: kafka:9092
    volumes:
      - notification-data:/data
    depends_on:
      - kafka
    networks:
      - app-network

  ai-service:
    build: ./ai-service
    ports:
      - "5005:5005"
    environment:
      NODE_ENV: development
      AI_SERVICE_PORT: 5005
    volumes:
      - ./ai-service/models:/models
      - ai-data:/data
    depends_on:
      - kafka
    networks:
      - app-network

  zookeeper:
    image: wurstmeister/zookeeper
    ports:
      - "2181:2181"
    networks:
      - app-network

  kafka:
    image: wurstmeister/kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: kafka
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "notifications:1:1"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - zookeeper
    networks:
      - app-network

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio12345
    volumes:
      - minio-data:/data
    networks:
      - app-network

  mlflow:
    image: python:3.10-slim
    working_dir: /mlflow
    ports:
      - "5001:5000"
    environment:
      MLFLOW_S3_ENDPOINT_URL: http://minio:9000
      AWS_ACCESS_KEY_ID: minio
      AWS_SECRET_ACCESS_KEY: minio12345
      AWS_DEFAULT_REGION: us-east-1
    volumes:
      - ./mlruns:/mlflow/mlruns
      - ./mlflow-start.sh:/mlflow/mlflow-start.sh
      - mlflow-data:/mlflow
    command: >
      sh -c "pip install --no-cache-dir 'mlflow==2.14.0' && \
             mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri sqlite:///mlflow.db"
    depends_on:
      - minio
    networks:
      - app-network

  zenml-db:
    image: mysql:8.0
    container_name: zenml-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: zenmlroot
      MYSQL_DATABASE: zenml
      MYSQL_USER: zenml
      MYSQL_PASSWORD: zenmlpass
    volumes:
      - zenmlmysqldata:/var/lib/mysql
    networks:
      - app-network

  zenml-server:
    image: zenmldocker/zenml-server:latest
    container_name: zenml-server
    restart: unless-stopped
    depends_on:
      - zenml-db
    ports:
      - "8080:8080"
    environment:
      ZENML_STORE_URL: mysql://zenml:zenmlpass@zenml-db:3306/zenml
      ZENML_DEFAULT_USER_NAME: admin
      ZENML_DEFAULT_USER_PASSWORD: zenml
    networks:
      - app-network

  model-serving:
    build: ./ai-service/serving
    ports:
      - "8000:8000"
    environment:
      MODEL_PATH: /app/models/model_v1.pt
    volumes:
      - ./ai-service/models:/app/models
    networks:
      - app-network
      
  # Prometheus for Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: air_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./ai-service/monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - ./ai-service/monitoring/prometheus/alerts.yml:/etc/prometheus/alerts.yml
      - prometheus_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
    networks:
      - app-network

  # Grafana for Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: air_grafana
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_SECURITY_ADMIN_USER: admin
      GF_USERS_ALLOW_SIGN_UP: false
    volumes:
      - ./ai-service/monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./ai-service/monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - app-network

volumes:
  user-data:
  aqi-data:
  location-data:
  notification-data:
  ai-data:
  minio-data:
  mlflow-data:
  zenmlmysqldata:
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

networks:
  app-network:
    driver: bridge
